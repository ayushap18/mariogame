/**
 * Level data and loader for the platformer.
 * Each level is a tile map using character codes:
 *   . = empty, # = ground, B = brick, ? = question block,
 *   P = pipe top, p = pipe body, C = coin, E = enemy,
 *   F = flag, M = mushroom block, = = bridge/platform,
 *   1 = player start, 2 = AI start
 */

const LEVELS = [
  {
    name: 'World 1-1',
    sky: '#5C94FC',
    ground: '#C84C0C',
    time: 400,
    map: [
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '..........C.C.C...................C.C.C...................C.C.C.................',
      '................................................................................',
      '........................................................................F.......',
      '..........C.C.C...................C.C.C....................C.C.C..=.=.=.=.##....',
      '..........?..?............E.......?B?B?..............E.........?..?.............',
      '................................................................................',
      '12..............................................................................',
      '##############..############..##############..################..###############.',
      '##############..############..##############..################..###############.',
    ],
  },
  {
    name: 'World 1-2',
    sky: '#000000',
    ground: '#C84C0C',
    time: 350,
    map: [
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '.........C.C.C.......................C.C.C.......................C.C.C...........',
      '................................................................................',
      '........................................................................F.......',
      '.........C.C.C..................C.C.C.......................C.C.C.=.=.=.=.##....',
      '.........?B?........E..........BB?BB..........E.............?B?B?..............',
      '................................................................................',
      '................................................................................',
      '12..............................................................................',
      '#############...##########...#############..PP..################..#############.',
      '#############...##########...#############..PP..################..#############.',
    ],
  },
  {
    name: 'World 1-3',
    sky: '#5C94FC',
    ground: '#C84C0C',
    time: 300,
    map: [
      '................................................................................',
      '................................................................................',
      '................................................................................',
      '...C.........C.C.C......................C.C.C.C..............................C...',
      '................................................................................',
      '..........C.C.C.............C.C.C.......................C.C.C...................',
      '.......................................................................F........',
      '..........C.C.C.............C.C.C..............C.C.C..........=.=.=.=.=.##.....',
      '......?B?B?.......E...........BB?BB.......E...........?B?B?........E...........',
      '...........?..?..?..................?..?..?..................?..?.................',
      '................................................................................',
      '12..............................................................................',
      '############..PP..##########..PP..############..PP..############..#############.',
      '############..PP..##########..PP..############..PP..############..#############.',
    ],
  },
];

function parseLevel(levelIndex) {
  const level = LEVELS[levelIndex];
  if (!level) return null;

  const map = level.map;
  const rows = map.length;
  const cols = Math.max(...map.map(r => r.length));

  const tiles = [];
  const entities = [];
  let playerStart = { x: 16, y: 160 };
  let aiStart = { x: 32, y: 160 };

  for (let r = 0; r < rows; r++) {
    tiles[r] = [];
    for (let c = 0; c < cols; c++) {
      const ch = map[r][c] || '.';
      tiles[r][c] = ch;

      const x = c * 16;
      const y = r * 16;

      switch (ch) {
        case 'E':
          entities.push({ type: 'enemy', subtype: 'goomba', x, y: y + 2, startX: x });
          tiles[r][c] = '.';
          break;
        case 'C':
          entities.push({ type: 'coin', x, y });
          tiles[r][c] = '.';
          break;
        case 'F':
          entities.push({ type: 'flag', x, y: y });
          tiles[r][c] = '.';
          break;
        case '1':
          playerStart = { x, y };
          tiles[r][c] = '.';
          break;
        case '2':
          aiStart = { x, y };
          tiles[r][c] = '.';
          break;
      }
    }
  }

  return {
    name: level.name,
    sky: level.sky,
    ground: level.ground,
    time: level.time,
    tiles,
    entities,
    playerStart,
    aiStart,
    rows,
    cols,
    width: cols * 16,
    height: rows * 16,
  };
}

function getLevelCount() {
  return LEVELS.length;
}

export { LEVELS, parseLevel, getLevelCount };
